<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <title>Caffora â€” Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

    <!-- Fonts & Bootstrap -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
      :root{ --gold:#ffd54f; --brown:#4b3f36; --muted:#8b8179; --border-soft:#e5e7eb; }
      body{
        font-family:"Poppins",sans-serif; margin:0; color:var(--brown);
        background:
          radial-gradient(circle at 20% 15%,rgba(255,248,219,.9) 0,rgba(255,248,219,0) 38%),
          radial-gradient(circle at 80% 10%,rgba(255,236,185,.9) 0,rgba(255,236,185,0) 38%),
          linear-gradient(160deg,#fff7d5 0%,#fffef8 42%,#ffffff 100%);
        min-height:100vh;
      }
      .login-wrap{ min-height:100vh; display:flex; justify-content:center; align-items:center; padding:16px; }
      .login-card{
        width:100%; max-width:520px; background:#fff; border-radius:20px;
        border:1px solid rgba(255,214,114,.35);
        box-shadow:0 28px 45px rgba(255,191,73,.12),0 8px 18px rgba(255,191,73,.08);
        padding:26px 30px 20px;
      }
      .header-brand{ text-align:center; margin-bottom:12px; }
      .header-brand .brand{ font-family:"Playfair Display",serif; font-weight:700; font-size:1.95rem; color:var(--brown); }
      .muted{ color:var(--muted); }

      .form-label{ font-size:13.5px; font-weight:600; margin-bottom:5px; }
      .form-control{ height:40px; border-radius:10px; border:1px solid var(--border-soft); font-size:14px; padding:0 14px; }
      .form-control:focus{ border-color:rgba(255,211,95,.9); box-shadow:none; }

      .pw-wrap{ position:relative; }
      .pw-toggle{
        position:absolute; right:10px; top:50%; transform:translateY(-50%);
        background:transparent; border:none; width:24px; height:24px; display:flex; align-items:center; justify-content:center; color:var(--brown); cursor:pointer;
      }

      .mb-field{ margin-bottom:16px; }
      .form-inline-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; font-size:12px; }

      .link-inline{ color:#0d6efd; text-decoration:none; font-size:12px; }
      .link-inline:hover{ text-decoration:underline; }

      .btn-brand{
        width:100%; height:42px; border-radius:10px; border:none;
        background:var(--gold); color:var(--brown); font-weight:600; font-size:.9rem;
      }
      .btn-brand:hover{ background:#ffe082; }

      .social-row{ display:flex; justify-content:center; gap:22px; }
      small{ font-size:12px; }

      .cf-alert{
        display:flex; align-items:center; gap:10px;
        background:#fff2f2; color:#9b2c2c;
        border:1px solid #ffb3b3; border-radius:10px;
        padding:10px 12px; font-size:13.5px; margin-bottom:12px;
        box-shadow:0 8px 18px rgba(255,179,179,.12);
        animation: cf-fade-in .18s ease-out;
      }
      .cf-alert .bi{font-size:16px; flex:0 0 auto;}
      .cf-alert .cf-close{
        margin-left:auto; border:none; background:transparent;
        color:#9b2c2c; font-size:18px; line-height:1; cursor:pointer; padding:0 4px;
      }
      @keyframes cf-fade-in{from{opacity:.4; transform:translateY(-2px)} to{opacity:1; transform:translateY(0)}}
      @keyframes cf-shake{10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-3px)} 40%,60%{transform:translateX(3px)}}
      .cf-shake{animation: cf-shake .4s;}

      @media (max-width:768px){
        body{ background:#fff; }
        .login-wrap{ min-height:100vh; display:flex; justify-content:center; align-items:center; padding-top:12px; padding-bottom:20px; }
        .login-card{ background:transparent; border:none; box-shadow:none; border-radius:0; max-width:360px; width:100%; margin:0 auto; padding:0 16px 16px; }
        .header-brand{ margin-bottom:10px; }
        .btn-brand{ border-radius:12px; }
      }
    </style>
  </head>
  <body>
    <div class="login-wrap">
      <div class="login-card">
        <div class="header-brand">
          <i class="bi bi-cup-hot-fill fs-1 text-warning"></i>
          <h2 class="brand mb-1">Caffora</h2>
          <p class="muted mb-0">Masuk ke akun Anda</p>
        </div>

      
        <div id="errBox" class="cf-alert" style="display:none" role="alert" aria-live="polite">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <span id="errMsg">Terjadi kesalahan.</span>
          <button type="button" class="cf-close" aria-label="Tutup">&times;</button>
        </div>

        <!-- form (akan di-intercept oleh JS) -->
        <form id="loginForm" action="/auth/login" method="post" autocomplete="off" novalidate>
          <div class="mb-field">
            <label for="identity" class="form-label">Email / Username</label>
            <input type="text" id="identity" name="identity" class="form-control" required />
          </div>

          <div class="mb-field">
            <label for="password" class="form-label">Password</label>
            <div class="pw-wrap">
              <input type="password" id="password" name="password" class="form-control" required />
              <button type="button" class="pw-toggle" id="togglePwBtn" aria-label="Tampilkan password">
                <i id="eyeIcon" class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <div class="form-inline-row">
            <label class="d-flex align-items-center gap-1 mb-0">
              <input type="checkbox" id="remember" name="remember" class="form-check-input m-0" style="width:14px;height:14px" />
              <span>Remember me</span>
            </label>
            <a href="#" class="link-inline">Forgot password?</a>
          </div>

          <button type="submit" id="loginBtn" class="btn-brand mb-2">Login</button>
        </form>

        <div class="text-center text-muted mt-2 mb-2" style="font-size:12px">
          atau masuk dengan
        </div>

        <div class="social-row mb-2">

          <!-- google -->
          <a href="#" aria-label="Login dengan Google" title="Google">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 533.5 544.3" role="img">
              <path fill="#4285F4" d="M533.5 278.4c0-17.4-1.6-34.1-4.6-50.4H272.1v95.3h146.9c-6.3 33.7-25.2 62.3-53.6 81.5l86.6 67.3c50.5-46.6 81.5-115.2 81.5-193.7z"/>
              <path fill="#34A853" d="M272.1 544.3c72.9 0 134.1-24.1 178.8-65.5l-86.6-67.3c-24 16.1-54.8 25.6-92.2 25.6-70.9 0-131-47.9-152.6-112.1l-89.7 69.3c44.5 88.1 135.6 150 242.3 150z"/>
              <path fill="#FBBC05" d="M119.5 324.9c-5.6-16.8-8.8-34.7-8.8-53s3.2-36.2 8.8-53l-89.7-69.3C10.6 181.1 0 226.8 0 271.9s10.6 90.8 29.8 122.3l89.7-69.3z"/>
              <path fill="#EA4335" d="M272.1 107.3c39.7 0 75.3 13.7 103.3 40.6l77.5-77.5C406.1 24.8 345 0 272.1 0 165.4 0 74.3 61.9 29.8 149.6l89.7 69.3c21.6-64.2 81.7-111.6 152.6-111.6z"/>
            </svg>
          </a>

          <!-- apple -->
          <a href="#" aria-label="Login dengan Apple" title="Apple">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" role="img" fill="#000">
              <path d="M16.365 1.43c0 1-.41 1.98-1.07 2.7-.69.76-1.84 1.34-2.85 1.24-.13-1.06.46-2.1 1.11-2.77.73-.75 1.99-1.3 2.81-1.17zM20.53 17.08c-.46 1.07-1.01 2.12-1.8 3.16-.96 1.25-2.16 2.8-3.74 2.83-1.4.03-1.85-.82-3.43-.82-1.58 0-2.07.8-3.46.85-1.59.06-2.8-1.35-3.77-2.59-2.06-2.62-3.65-7.41-1.52-10.64 1.08-1.66 2.9-2.71 4.92-2.74 1.53-.03 2.97 1.02 3.43 1.02.46 0 2.38-1.26 4.01-1.07.68.03 2.59.28 3.82 2.16-3.36 1.78-2.83 6.41.54 7.83z"/>
            </svg>
          </a>

          <!-- facebook -->
          <a href="#" aria-label="Login dengan Facebook" title="Facebook">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" role="img">
              <path fill="#1877F2" d="M24 12a12 12 0 1 0-13.875 11.85v-8.385H7.077V12h3.048V9.356c0-3.012 1.793-4.687 4.533-4.687 1.312 0 2.686.235 2.686.235v2.953h-1.514c-1.494 0-1.96.929-1.96 1.883V12h3.328l-.532 3.465h-2.796v8.385A12.002 12.002 0 0 0 24 12"/>
            </svg>
          </a>
        </div>

        <div class="text-center mt-1 mb-1">
          <small>Belum punya akun? <a href="/register" class="link-inline">Register</a></small>
        </div>
      </div>
    </div>

    <script>
      // toggle password
      (function(){
        const pw = document.getElementById("password");
        const btn = document.getElementById("togglePwBtn");
        const ic  = document.getElementById("eyeIcon");
        btn.addEventListener("click", () => {
          const show = pw.type === "password";
          pw.type = show ? "text" : "password";
          ic.classList.toggle("bi-eye", !show);
          ic.classList.toggle("bi-eye-slash", show);
        });
      })();

      // AJAX login + error inline
      (function(){
        const form = document.getElementById('loginForm');
        const btn  = document.getElementById('loginBtn');
        const box  = document.getElementById('errBox');
        const msg  = document.getElementById('errMsg');
        const closeBtn = box.querySelector('.cf-close');
        let autoHideId = null;

        function showErr(text){
          msg.textContent = text || 'Login gagal. Coba lagi.';
          box.style.display = 'flex';
          box.classList.remove('cf-shake');
          void box.offsetWidth;            // reflow untuk retrigger anim
          box.classList.add('cf-shake');

          clearTimeout(autoHideId);
          autoHideId = setTimeout(()=>{ hideErr(); }, 6000);
        }
        function hideErr(){
          clearTimeout(autoHideId);
          box.style.display = 'none';
          msg.textContent = '';
        }
        closeBtn.addEventListener('click', hideErr);
        ['identity','password'].forEach(id=>{
          const el = document.getElementById(id);
          el.addEventListener('input', hideErr);
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          hideErr();

          const identity = (document.getElementById('identity').value || '').trim();
          const password = (document.getElementById('password').value || '').trim();
          const remember = document.getElementById('remember')?.checked ?? false;

          if(!identity || !password){
            showErr('Email/Username dan password wajib diisi.');
            return;
          }

          btn.disabled = true;
          const oldLabel = btn.textContent;
          btn.textContent = 'Memproses...';

          try {
            const res = await fetch('/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest' // paksa backend ke jalur JSON
              },
              body: JSON.stringify({ identity, password, remember })
            });

            let data = null;
            try { data = await res.json(); } catch (_) {}

            if (!res.ok) {
              showErr((data && data.message) || 'Login gagal. Coba lagi.');
              return;
            }

            if (data.status === 'success' && data.redirect) {
              window.location.href = data.redirect; return;
            }
            if (data.status === 'need_verification' && data.email) {
              window.location.href = '/verify_otp?email=' + encodeURIComponent(data.email); return;
            }
            if (data.status === 'error' && data.message) {
              showErr(data.message); return;
            }
            showErr('Login gagal. Coba lagi.');
          } catch (err) {
            showErr('Jaringan bermasalah. Periksa koneksi Anda.');
          } finally {
            btn.disabled = false;
            btn.textContent = oldLabel;
          }
        });
      })();
    </script>
  </body>
</html>