<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <title>Caffora — Register</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts & Bootstrap -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --gold: #ffd54f;
        --brown: #4b3f36;
        --ink: #2e2823;
        --muted: #8b8179;
        --surface-rgb: 255, 255, 255;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Poppins", sans-serif;
        margin: 0;
        color: var(--ink);
        background: radial-gradient(
            circle at 20% 15%,
            rgba(255, 248, 219, 0.9) 0%,
            rgba(255, 248, 219, 0) 38%
          ),
          radial-gradient(
            circle at 80% 10%,
            rgba(255, 236, 185, 0.9) 0%,
            rgba(255, 236, 185, 0) 38%
          ),
          linear-gradient(160deg, #fff7d5 0%, #fffef8 42%, #ffffff 100%);
        position: relative;
      }
      @media (min-width: 769px) {
        body {
          background: url("assets/img/bg.jpg") center/cover no-repeat fixed;
        }
        body::before {
          content: "";
          position: fixed;
          inset: 0;
          pointer-events: none;
          z-index: 0;
          background: radial-gradient(
              80% 80% at 50% 30%,
              rgba(255, 239, 196, 0.18) 0%,
              rgba(255, 239, 196, 0) 60%
            ),
            radial-gradient(
              120% 90% at 50% 120%,
              rgba(0, 0, 0, 0.18) 0%,
              rgba(0, 0, 0, 0) 70%
            );
        }
      }
      .reg-wrap {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        position: relative;
        z-index: 1;
      }
      .reg-card {
        width: 100%;
        max-width: 720px;
        background: rgba(var(--surface-rgb), 0.76);
        -webkit-backdrop-filter: blur(14px) saturate(125%);
        backdrop-filter: blur(14px) saturate(125%);
        border-radius: 20px;
        border: 1px solid rgba(255, 214, 114, 0.35);
        box-shadow: 0 22px 48px rgba(0, 0, 0, 0.08),
          0 5px 14px rgba(0, 0, 0, 0.04),
          inset 0 1px 0 rgba(255, 255, 255, 0.35);
        padding: 22px 24px 20px;
        opacity: 0;
        transform: translateY(12px) scale(0.985);
        filter: saturate(0.95) blur(2px);
        animation: cardIn 0.6s cubic-bezier(0.2, 0.7, 0.2, 1) 0.04s forwards;
      }
      @keyframes cardIn {
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: none;
        }
      }
      .header-brand {
        text-align: center;
        margin-bottom: 14px;
        opacity: 0;
        transform: translateY(6px);
        animation: fadeUp 0.5s ease-out 0.16s forwards;
      }
      .header-brand .brand {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        font-size: 1.7rem;
        color: var(--brown);
      }
      .muted {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .form-grid {
        display: grid;
        gap: 16px 18px;
      }
      @media (min-width: 992px) {
        .form-grid {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }
        .stack {
          display: grid;
          gap: 16px;
        }
        .col-span-2 {
          grid-column: 1 / -1;
        }
      }

      .form-label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .form-control {
        height: 40px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid rgba(46, 40, 35, 0.15);
        font-size: 13.5px;
        padding: 0 14px;
        transition: border-color 0.18s ease, background-color 0.2s ease;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.55);
      }
      .form-control:hover {
        border-color: rgba(246, 198, 58, 0.45);
      }
      .form-control:focus {
        outline: none !important;
        box-shadow: none !important;
        border-color: rgba(246, 198, 58, 0.8);
        background-color: rgba(255, 255, 255, 0.98);
      }
      .hint {
        font-size: 0.8rem;
        margin-top: 4px;
      }
      .hint.error {
        color: #000000;
      }

      .pw-wrap {
        position: relative;
      }
      .pw-input {
        height: 40px;
        border-radius: 10px;
        padding-right: 42px;
      }
      .pw-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--brown);
        cursor: pointer;
      }

      .agree-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12.5px;
        color: var(--muted);
        margin-top: 2px;
        opacity: 0;
        transform: translateY(6px);
        animation: fadeUp 0.45s ease-out 0.56s forwards;
      }
      .agree-row input[type="checkbox"] {
        width: 14px;
        height: 14px;
        cursor: pointer;
      }

      .btn-brand {
        width: 100%;
        max-width: 420px;
        height: 42px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(180deg, var(--gold) 0%, #ffc92b 100%);
        color: var(--brown);
        font-weight: 700;
        font-size: 0.92rem;
        margin: 0 auto;
        display: block;
        opacity: 0;
        transform: translateY(6px);
        animation: fadeUp 0.45s ease-out 0.64s forwards;
      }
      .btn-brand:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .social-title {
        text-align: center;
        font-size: 13px;
        font-weight: 400;
        color: var(--muted);
        margin: 14px 0 8px;
      }
      .social-row {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-bottom: 6px;
        opacity: 0;
        transform: translateY(6px);
        animation: fadeUp 0.5s ease-out 0.52s forwards;
      }
      .social-row a:hover svg {
        transform: translateY(-3px) scale(1.05);
        opacity: 0.9;
      }
      .to-login {
        text-align: center;
        margin-top: 10px;
        color: var(--ink);
      }
      .to-login a {
        color: #1a73e8;
        text-decoration: none;
        font-weight: 500;
      }
      @keyframes fadeUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ===== Modal S&K ===== */
      .modal.custom-terms {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        padding: 16px;
        z-index: 1055;
      }
      .modal.custom-terms.open {
        display: flex;
      }

      /* Scroll seluruh kartu, border tetap melengkung rapi */
      .modal-card {
        width: 100%;
        max-width: 640px;
        max-height: 70vh;
        background: #fff;
        border-radius: 14px;
        overflow: auto;
        display: block;
        scrollbar-gutter: stable both-edges; /* jaga radius tetap utuh */
      }

      .modal-card::-webkit-scrollbar {
        width: 10px;
      }
      .modal-card::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 10px;
      }
      .modal-card::-webkit-scrollbar-track {
        background: transparent;
        margin: 14px;
      }
      .modal-card {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.25) transparent;
      }

      /* Head & foot tanpa border agar minimalis */
      .modal-head {
        padding: 14px 16px 12px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .modal-title {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .modal-body {
        padding: 16px;
        line-height: 1.6;
        font-size: 0.9rem;
        overflow: visible;
      }

      .modal-foot {
        padding: 12px 16px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      /* Tombol Batal & Setuju */
      .btn-outline-foot {
        background: #f3f3f3;
        border: 0px solid #d1d1d1;
        color: #333;
        border-radius: 12px;
        height: 38px;
        padding: 0 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      .btn-outline-foot:hover {
        background: #e0e0e0;
        border-color: #bbb;
      }

      .btn-accept {
        background: var(--gold);
        color: var(--brown);
        border: 0;
        border-radius: 12px;
        height: 38px;
        padding: 0 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .btn-accept:hover {
        background: #f7cc40;
      }
      .btn-accept:disabled {
        background: #f0e3b0;
        color: #9b8a5d;
      }

      @media (max-width: 768px) {
        body {
          background: #fff;
        }
        .reg-card {
          max-width: 360px;
          background: #fff;
          border: none;
          box-shadow: none;
          border-radius: 0;
          padding: 0 16px 16px;
        }
        .form-grid {
          grid-template-columns: 1fr;
          gap: 14px;
        }
        .stack {
          gap: 14px;
        }
        .btn-brand {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="reg-wrap">
      <div class="reg-card">
        <div class="header-brand">
          <i class="bi bi-cup-hot-fill fs-1 text-warning"></i>
          <h2 class="brand mb-1">Caffora</h2>
          <p class="muted mb-0">Buat akun pelanggan</p>
        </div>

        <!-- FORM -->
        <form
          id="registerForm"
          action="/backend/auth_register.php"
          method="post"
          novalidate
        >
          <div class="form-grid">
            <!-- kiri -->
            <div class="stack">
              <div class="mb-field">
                <label class="form-label" for="name">Username</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-control"
                  placeholder="Minimal 5 huruf (A–Z)"
                  autocomplete="off"
                />
                <small id="nameHint" class="hint"></small>
              </div>

              <div class="mb-field">
                <label class="form-label" for="email">Email</label>
                <!-- type=text agar tidak ada bubble “Input tidak valid” -->
                <input
                  type="text"
                  id="email"
                  name="email"
                  class="form-control"
                  placeholder="email@contoh.com"
                  autocomplete="off"
                  inputmode="email"
                />
                <small id="emailHint" class="hint"></small>
              </div>
            </div>

            <!-- kanan -->
            <div class="stack">
              <div class="mb-field">
                <label class="form-label" for="password">Password</label>
                <div class="pw-wrap">
                  <input
                    type="password"
                    id="password"
                    name="password"
                    class="form-control pw-input"
                    placeholder="Minimal 6 karakter (huruf & angka)"
                  />
                  <button
                    type="button"
                    class="pw-toggle"
                    id="togglePw1"
                    aria-label="Tampilkan password"
                  >
                    <i id="eyeIcon1" class="bi bi-eye"></i>
                  </button>
                </div>
                <small id="pwHint" class="hint"></small>
              </div>

              <div class="mb-field">
                <label class="form-label" for="confirm_password"
                  >Konfirmasi Password</label
                >
                <div class="pw-wrap">
                  <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    class="form-control pw-input"
                    placeholder="Ulangi password"
                  />
                  <button
                    type="button"
                    class="pw-toggle"
                    id="togglePw2"
                    aria-label="Tampilkan konfirmasi password"
                  >
                    <i id="eyeIcon2" class="bi bi-eye"></i>
                  </button>
                </div>
                <small id="cpwHint" class="hint"></small>
              </div>
            </div>

            <!-- S&K -->
            <div class="agree-row col-span-2">
              <input id="agree" name="agree" type="checkbox" disabled />
              <label for="agree" class="m-0">
                Saya setuju dengan
                <a
                  href="#"
                  id="openTerms"
                  style="color: #0d6efd; font-weight: 500"
                  >Syarat & Ketentuan</a
                >
              </label>
            </div>

            <!-- Tombol -->
            <div class="col-span-2">
              <button
                type="submit"
                class="btn-brand"
                id="btnSubmit"
                formnovalidate
                disabled
              >
                Daftar
              </button>
            </div>
          </div>
        </form>

        <div class="social-title">atau daftar dengan</div>
        <div class="social-row">
          <!-- ikon dipertahankan -->
          <a href="#" aria-label="Google" title="Google"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 533.5 544.3"
            >
              <path
                fill="#4285F4"
                d="M533.5 278.4c0-17.4-1.6-34.1-4.6-50.4H272.1v95.3h146.9c-6.3 33.7-25.2 62.3-53.6 81.5l86.6 67.3c50.5-46.6 81.5-115.2 81.5-193.7z"
              />
              <path
                fill="#34A853"
                d="M272.1 544.3c72.9 0 134.1-24.1 178.8-65.5l-86.6-67.3c-24 16.1-54.8 25.6-92.2 25.6-70.9 0-131-47.9-152.6-112.1l-89.7 69.3c44.5 88.1 135.6 150 242.3 150z"
              />
              <path
                fill="#FBBC05"
                d="M119.5 324.9c-5.6-16.8-8.8-34.7-8.8-53s3.2-36.2 8.8-53l-89.7-69.3C10.6 181.1 0 226.8 0 271.9s10.6 90.8 29.8 122.3l89.7-69.3z"
              />
              <path
                fill="#EA4335"
                d="M272.1 107.3c39.7 0 75.3 13.7 103.3 40.6l77.5-77.5C406.1 24.8 345 0 272.1 0 165.4 0 74.3 61.9 29.8 149.6l89.7 69.3c21.6-64.2 81.7-111.6 152.6-111.6z"
              /></svg
          ></a>
          <a href="#" aria-label="Apple" title="Apple"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="#000"
            >
              <path
                d="M16.365 1.43c0 1-.41 1.98-1.07 2.7-.69.76-1.84 1.34-2.85 1.24-.13-1.06.46-2.1 1.11-2.77.73-.75 1.99-1.3 2.81-1.17zM20.53 17.08c-.46 1.07-1.01 2.12-1.8 3.16-.96 1.25-2.16 2.8-3.74 2.83-1.4.03-1.85-.82-3.43-.82-1.58 0-2.07.8-3.46.85-1.59.06-2.8-1.35-3.77-2.59-2.06-2.62-3.65-7.41-1.52-10.64 1.08-1.66 2.9-2.71 4.92-2.74 1.53-.03 2.97 1.02 3.43 1.02.46 0 2.38-1.26 4.01-1.07.68.03 2.59.28 3.82 2.16-3.36 1.78-2.83 6.41.54 7.83z"
              /></svg
          ></a>
          <a href="#" aria-label="Facebook" title="Facebook"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
            >
              <path
                fill="#1877F2"
                d="M24 12a12 12 0 1 0-13.875 11.85v-8.385H7.077V12h3.048V9.356c0-3.012 1.793-4.687 4.533-4.687 1.312 0 2.686.235 2.686.235v2.953h-1.514c-1.494 0-1.96.929-1.96 1.883V12h3.328l-.532 3.465h-2.796v8.385A12.002 12.002 0 0 0 24 12"
              /></svg
          ></a>
        </div>

        <div class="to-login">
          <small>Sudah punya akun? <a href="login.html">Login</a></small>
        </div>
      </div>
    </div>

    <!-- MODAL S&K -->
    <div
      class="modal custom-terms"
      id="termsModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="termsTitle"
    >
      <div class="modal-card">
        <div class="modal-head">
          <div>
            <h3 class="modal-title" id="termsTitle">Syarat &amp; Ketentuan</h3>
            <div style="font-size: 0.8rem; color: #888">Caffora</div>
          </div>
          <!-- tombol Tutup dihapus: cukup Batal / backdrop / Setuju menutup -->
        </div>

        <div
          class="modal-body"
          id="termsBody"
          style="font-size: 0.92rem; line-height: 1.6"
        >
          <ol
            style="
              list-style-type: upper-alpha;
              padding-left: 1.1rem;
              margin: 0;
            "
          >
            <li>
              <strong>Akun & Keamanan</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Pengguna wajib memberikan data yang benar dan valid saat
                  pendaftaran.
                </li>
                <li>
                  Pengguna bertanggung jawab atas kerahasiaan akun dan aktivitas
                  yang terjadi.
                </li>
                <li>
                  Caffora berhak menonaktifkan akun atas indikasi penyalahgunaan
                  atau pelanggaran.
                </li>
              </ol>
            </li>

            <li>
              <strong>Informasi Menu & Harga</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Menu, harga, dan ketersediaan dapat berubah sewaktu-waktu.
                </li>
                <li>
                  Jika terjadi kesalahan informasi atau sistem, Caffora berhak
                  melakukan pembatalan.
                </li>
              </ol>
            </li>

            <li>
              <strong>Pemesanan & Pembayaran</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Pesanan dianggap sah setelah pembayaran berhasil dan
                  terverifikasi.
                </li>
                <li>
                  Metode pembayaran mengikuti opsi yang tersedia pada
                  aplikasi/gerai.
                </li>
              </ol>
            </li>

            <li>
              <strong>Layanan Dine-in & Takeaway</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Pesanan dine-in hanya dapat digunakan di gerai Caffora yang
                  berlaku.
                </li>
                <li>
                  Pesanan takeaway wajib diambil sesuai estimasi waktu
                  pengambilan.
                </li>
                <li>
                  Keterlambatan pengambilan dapat memengaruhi kualitas, dan
                  tidak menjadi dasar penggantian.
                </li>
              </ol>
            </li>

            <li>
              <strong>Pembatalan & Pengembalian Dana</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Pembatalan hanya dapat dilakukan sebelum pesanan diproses.
                </li>
                <li>
                  Pesanan yang sudah diproses tidak dapat dibatalkan kecuali
                  terjadi kesalahan dari pihak Caffora.
                </li>
                <li>
                  Proses refund mengikuti prosedur dan waktu pemrosesan pihak
                  penyedia pembayaran.
                </li>
              </ol>
            </li>

            <li>
              <strong>Keluhan & Kualitas Produk</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>Periksa pesanan saat diterima.</li>
                <li>
                  Keluhan terkait kualitas dapat diajukan maksimal 1×24 jam.
                </li>
              </ol>
            </li>

            <li>
              <strong>Privasi Data</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Data Pengguna digunakan untuk kebutuhan layanan dan
                  operasional.
                </li>
                <li>
                  Caffora tidak membagikan data tanpa dasar hukum atau izin sah.
                </li>
              </ol>
            </li>

            <li>
              <strong>Kekayaan Intelektual</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>Logo, desain, dan konten merupakan milik Caffora.</li>
                <li>
                  Dilarang memperbanyak atau menggunakan konten tanpa izin
                  tertulis.
                </li>
              </ol>
            </li>

            <li>
              <strong>Batasan Tanggung Jawab</strong>
              <ol style="list-style-type: decimal; padding-left: 1rem">
                <li>
                  Layanan dapat dipengaruhi kondisi teknis dan operasional.
                </li>
                <li>
                  Tanggung jawab maksimal atas keluhan valid adalah sebesar
                  nilai transaksi terkait.
                </li>
              </ol>
            </li>
          </ol>

          <div style="height: 100px"></div>
        </div>

        <div class="modal-foot">
          <button class="btn-outline-foot" id="cancelTerms">Batal</button>
          <button class="btn-accept" id="acceptTerms" disabled>Setuju</button>
        </div>
      </div>
    </div>

    <script>
      // ===== Helpers =====
      const qs = (s) => document.querySelector(s);
      const nameEl = qs("#name"),
        nameHint = qs("#nameHint");
      const emailEl = qs("#email"),
        emailHint = qs("#emailHint");
      const pwEl = qs("#password"),
        cpwEl = qs("#confirm_password");
      const pwHint = qs("#pwHint"),
        cpwHint = qs("#cpwHint");
      const agreeCb = qs("#agree"),
        btnSubmit = qs("#btnSubmit");
      const form = qs("#registerForm");
      const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;

      function setHint(el, msg, isErr) {
        el.textContent = msg || "";
        el.classList.toggle("error", !!isErr);
      }

      let emailTaken = false;
      let emailChecking = false; // <-- baru

      function updateSubmitState() {
        const uok = /^[A-Za-z]{5,}$/.test(nameEl.value.trim());
        const eok = EMAIL_RE.test(emailEl.value.trim());
        const pok = pwEl.value.length >= 6;
        const cok = cpwEl.value && cpwEl.value === pwEl.value;
        // kunci juga saat sedang cek email
        btnSubmit.disabled =
          !(uok && eok && pok && cok && agreeCb.checked) ||
          emailTaken ||
          emailChecking;
      }

      // Username: filter huruf saja (hilangin angka/underscore)
      nameEl.addEventListener("input", () => {
        const cleaned = nameEl.value.replace(/[^A-Za-z]/g, "");
        if (cleaned !== nameEl.value) nameEl.value = cleaned;
        setHint(
          nameHint,
          nameEl.value && nameEl.value.length < 5
            ? "Minimal 5 huruf (A–Z)."
            : "",
          nameEl.value.length && nameEl.value.length < 5
        );
        updateSubmitState();
      });

      // Email exists checker (debounce + lock submit saat cek)
      let debounce = null;
      async function doCheckEmail() {
        const val = emailEl.value.trim();
        if (!EMAIL_RE.test(val)) {
          setHint(emailHint, "", false);
          emailTaken = false;
          updateSubmitState();
          return;
        }
        emailChecking = true;
        updateSubmitState(); // <-- lock
        try {
          const url = new URL("/backend/check_email.php", location.origin);
          url.searchParams.set("email", val);
          const res = await fetch(url.toString(), {
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              Accept: "application/json",
            },
            cache: "no-store",
          });
          const data = await res.json().catch(() => ({}));
          if (data && data.exists) {
            setHint(
              emailHint,
              "Email tersebut sudah terdaftar. Silakan login.",
              true
            );
            emailTaken = true;
          } else {
            setHint(emailHint, "", false);
            emailTaken = false;
          }
        } catch (_) {
          // kalau gagal cek, jangan menghalangi user, tapi jangan tampilkan error
          setHint(emailHint, "", false);
          emailTaken = false;
        } finally {
          emailChecking = false;
          updateSubmitState();
        }
      }
      emailEl.addEventListener("input", () => {
        clearTimeout(debounce);
        debounce = setTimeout(doCheckEmail, 400);
      });

      // Password checks
      function checkPw() {
        setHint(
          pwHint,
          pwEl.value.length && pwEl.value.length < 6
            ? "Minimal 6 karakter."
            : "",
          pwEl.value.length < 6
        );
        setHint(
          cpwHint,
          cpwEl.value && cpwEl.value !== pwEl.value
            ? "Konfirmasi tidak sama."
            : "",
          cpwEl.value && cpwEl.value !== pwEl.value
        );
        updateSubmitState();
      }
      pwEl.addEventListener("input", checkPw);
      cpwEl.addEventListener("input", checkPw);

      // Toggle password
      (function () {
        const pairs = [
          { input: "password", btn: "togglePw1", icon: "eyeIcon1" },
          { input: "confirm_password", btn: "togglePw2", icon: "eyeIcon2" },
        ];
        pairs.forEach(({ input, btn, icon }) => {
          const pw = document.getElementById(input),
            b = document.getElementById(btn),
            ic = document.getElementById(icon);
          b.addEventListener("click", () => {
            const show = pw.type === "password";
            pw.type = show ? "text" : "password";
            ic.classList.toggle("bi-eye", !show);
            ic.classList.toggle("bi-eye-slash", show);
          });
        });
      })();

      // ===== modal S&K =====
      (function () {
        const modal = document.getElementById("termsModal");
        const openBtn = document.getElementById("openTerms");
        const cancelBtn = document.getElementById("cancelTerms");
        const acceptBtn = document.getElementById("acceptTerms");
        const agreeCb = document.getElementById("agree");

        // kontainer scroll sekarang seluruh kartu
        const modalCard = document.querySelector("#termsModal .modal-card");
        const termsBody = document.getElementById("termsBody");

        function openModal() {
          modal.classList.add("open");
          modalCard.scrollTop = 0;
          // Jika kontennya pendek, langsung enable
          setTimeout(() => {
            if (modalCard.scrollHeight <= modalCard.clientHeight + 2) {
              acceptBtn.disabled = false;
            }
          }, 50);
        }
        function closeModal() {
          modal.classList.remove("open");
        }

        openBtn.addEventListener("click", (e) => {
          e.preventDefault();
          openModal();
        });
        cancelBtn.addEventListener("click", closeModal);

        // aktifkan "Setuju" ketika sudah scroll ke dasar konten
        modalCard.addEventListener("scroll", () => {
          const atBottom =
            modalCard.scrollTop + modalCard.clientHeight >=
            modalCard.scrollHeight - 2;
          if (atBottom) acceptBtn.disabled = false;
        });

        acceptBtn.addEventListener("click", () => {
          agreeCb.disabled = false;
          agreeCb.checked = true;
          closeModal();
        });

        // klik backdrop menutup modal
        modal.addEventListener("click", (ev) => {
          if (ev.target === modal) closeModal();
        });
      })();

      // Submit: tampilkan error field dari server, jangan redirect kalau gagal
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const uname = nameEl.value.trim();
        const email = emailEl.value.trim();
        if (!/^[A-Za-z]{5,}$/.test(uname)) {
          setHint(nameHint, "Minimal 5 huruf (A–Z).", true);
          return;
        }
        if (!EMAIL_RE.test(email)) {
          setHint(emailHint, "Format email tidak valid.", true);
          return;
        }
        if (emailTaken) {
          setHint(
            emailHint,
            "Email tersebut sudah terdaftar. Silakan login.",
            true
          );
          return;
        }
        if (pwEl.value.length < 6) {
          setHint(pwHint, "Minimal 6 karakter.", true);
          return;
        }
        if (pwEl.value !== cpwEl.value) {
          setHint(cpwHint, "Konfirmasi tidak sama.", true);
          return;
        }
        if (!agreeCb.checked) {
          return;
        }

        btnSubmit.disabled = true;
        try {
          const fd = new FormData(form);
          const res = await fetch("/backend/auth_register.php", {
            method: "POST",
            body: fd,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              Accept: "application/json",
            },
            cache: "no-store",
          });

          const isJson = res.headers
            .get("content-type")
            ?.includes("application/json");
          if (isJson) {
            const data = await res.json().catch(() => ({}));

            if (data?.ok && data?.redirect) {
              location.href = data.redirect;
              return;
            }

            // Tampilkan pesan dari server sesuai field
            if (data?.field === "email" && data?.code === "email_exists") {
              setHint(
                emailHint,
                "Email tersebut sudah terdaftar. Silakan login.",
                true
              );
              return;
            }
            if (data?.field === "name" && data?.msg) {
              setHint(nameHint, data.msg, true);
              return;
            }
            if (data?.field === "password" && data?.msg) {
              setHint(pwHint, data.msg, true);
              return;
            }
            if (data?.field === "confirm_password" && data?.msg) {
              setHint(cpwHint, data.msg, true);
              return;
            }

            // kalau server kirim ok:false tanpa field, tampilkan general
            if (data?.ok === false && data?.msg) {
              alert(data.msg);
              return;
            }
          }

          // kalau bukan JSON (atau kosong), tetap arahkan (fallback)
          location.href =
            "/public/verify_otp.html?email=" + encodeURIComponent(email);
        } catch (_) {
          // jaringan error → arahkan ke verify (kebijakan kamu sebelumnya)
          location.href =
            "/public/verify_otp.html?email=" + encodeURIComponent(email);
        } finally {
          btnSubmit.disabled = false;
        }
      });

      // init state
      updateSubmitState();
    </script>
  </body>
</html>
