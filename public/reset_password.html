<!DOCTYPE html>
<!-- Deklarasi dokumen HTML5 -->
<html lang="id">
  <!-- Set bahasa dokumen ke Bahasa Indonesia -->
  <head>
    <!-- Bagian head: meta, title, link font & style -->
    <meta charset="utf-8" />
    <!-- Encoding karakter UTF-8 -->
    <title>Caffora â€” Reset Password</title>
    <!-- Judul halaman di tab browser -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Supaya tampilan responsif di mobile -->

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Import font Playfair Display & Poppins dari Google Fonts -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Import Bootstrap Icons dari CDN -->

    <style>
      :root {
        --gold: #ffd54f; /* Warna kuning emas untuk tombol */
        --brown: #4b3f36; /* Warna cokelat untuk teks & elemen utama */
        --ink: #2e2823; /* Warna tinta gelap untuk teks */
        --muted: #8b8179; /* Warna teks sekunder/terang */
        --surface-rgb: 255, 255, 255; /* RGB untuk warna permukaan (putih) */
      }

      * {
        box-sizing: border-box; /* Semua elemen pakai box-sizing border-box */
      }

      html,
      body {
        height: 100%; /* Tinggi html & body full viewport */
      }

      /* Background full putih */
      body {
        font-family: "Poppins", sans-serif; /* Font utama halaman */
        margin: 0; /* Hilangkan margin default body */
        color: var(--ink); /* Warna teks default */
        background: #ffffff; /* full white */ /* Background putih polos */
        position: relative; /* Untuk positioning elemen lain jika perlu */
      }

      .reg-wrap {
        min-height: 100vh; /* Wrapper minimal setinggi layar */
        display: flex; /* Gunakan flexbox */
        justify-content: center; /* Center horizontal konten */
        align-items: center; /* Center vertikal konten */
        padding: 20px; /* Padding supaya konten tidak nempel tepi layar */
        position: relative; /* Posisi relatif di atas background */
        z-index: 1; /* Pastikan di atas layer lain jika ada */
      }

      /* Hilangkan gaya "card" agar tampak menyatu dengan background putih */
      .reg-card {
        width: 100%; /* Lebar penuh container yang tersedia */
        max-width: 720px; /* Maksimal lebar card di layar besar */
        background: transparent; /* no card background */ /* Tidak ada kotak putih khusus */
        -webkit-backdrop-filter: none; /* Tidak pakai blur background di Safari */
        backdrop-filter: none; /* Tidak pakai blur background di browser lain */
        border-radius: 0; /* Sudut tidak dibulatkan */
        border: none; /* Tanpa border */
        padding: 0; /* kita atur spacing di dalam form-stack */ /* Ruang diatur di elemen dalamnya */
        box-shadow: none; /* Hilangkan bayangan card */
        opacity: 1; /* Langsung terlihat (tanpa animasi fade-in) */
        transform: none; /* Tidak ada transformasi awal */
      }

      .header-brand {
        text-align: center; /* Header teks rata tengah */
        margin-bottom: 8px; /* Jarak bawah header */
      }
      .header-brand .brand {
        font-family: "Playfair Display", serif; /* Font khusus judul/brand */
        font-weight: 700; /* Tebal untuk nama brand */
        font-size: 1.9rem; /* Ukuran huruf cukup besar */
        color: var(--brown); /* Warna brand cokelat */
      }
      .header-brand .muted {
        color: var(--muted); /* Warna teks deskripsi header */
        font-size: 0.92rem; /* Ukuran sedikit lebih kecil */
      }

      .form-stack {
        max-width: 520px; /* Lebar maksimum area form di tengah */
        margin: 10px auto 24px; /* Center horizontal + margin atas & bawah */
        padding: 18px 22px; /* beri sedikit ruang agar tidak menempel ke tepi */ /* Ruang di dalam stack */
      }

      .form-group {
        margin-bottom: 14px; /* Jarak antar field/form-group */
      }

      .form-label {
        font-size: 13px; /* Ukuran teks label kecil */
        font-weight: 600; /* Label agak ditebalkan */
        margin-bottom: 6px; /* Jarak label ke input */
        display: block; /* Label tampil satu baris penuh */
      }

      .form-control {
        height: 40px; /* Tinggi input */
        border-radius: 10px; /* Sudut input membulat */
        background: #fff; /* Background input putih */
        border: 1px solid rgba(46, 40, 35, 0.12); /* Border tipis abu kecokelatan */
        font-size: 13.5px; /* Ukuran teks input */
        padding: 0 14px; /* Padding kiri kanan untuk teks */
        transition: border-color 0.18s ease, background-color 0.2s ease; /* Animasi halus saat fokus/hover */
        width: 100%; /* Input selalu selebar container */
      }
      .form-control[readonly] {
        background-color: #f5f7f8; /* Warna lebih abu untuk input readonly */
        color: #6b7280; /* Warna teks readonly abu sedang */
      }
      .form-control:hover {
        border-color: rgba(
          246,
          198,
          58,
          0.45
        ); /* Warna border sedikit kuning saat hover */
      }
      .form-control:focus {
        outline: none !important; /* Hilangkan outline default */
        box-shadow: none !important; /* Hilangkan shadow default focus */
        border-color: rgba(
          246,
          198,
          58,
          0.8
        ); /* Warna border kuning lebih kuat saat fokus */
        background-color: rgba(
          255,
          255,
          255,
          0.98
        ); /* Background sedikit lebih terang saat fokus */
      }

      .otp-row {
        display: flex; /* Baris horizontal untuk input OTP dan tombol */
        align-items: center; /* Vertikal tengah */
        gap: 8px; /* Jarak antara input dan tombol */
        width: 100%; /* Lebar penuh */
      }
      .otp-row .form-control {
        flex: 1 1 auto; /* Input OTP fleksibel isi ruang */
        min-width: 0; /* Hindari overflow di flex container */
      }

      .btn-brand {
        width: 100%; /* Tombol simpan selebar form */
        height: 44px; /* Tinggi tombol */
        border-radius: 10px; /* Sudut tombol membulat */
        border: none; /* Tanpa border tambahan */
        background: linear-gradient(
          180deg,
          var(--gold) 0%,
          #ffc92b 100%
        ); /* Gradasi kuning ke bawah */
        color: var(--brown); /* Warna teks tombol cokelat */
        font-weight: 700; /* Teks tombol ditebalkan */
        font-size: 0.96rem; /* Ukuran teks tombol */
        margin: 0 auto; /* Center tombol (kalau ada lebar max) */
        cursor: pointer; /* Pointer saat hover */
        transition: transform 0.12s ease; /* Animasi kecil saat hover */
      }
      .btn-brand:hover:not(:disabled) {
        transform: translateY(-1px); /* Tombol naik sedikit saat hover */
      }

      .btn-verify {
        height: 40px; /* Tinggi tombol verifikasi sejajar dengan input OTP */
        border-radius: 10px; /* Sudut membulat */
        border: none; /* Tanpa border tambahan */
        background: linear-gradient(
          180deg,
          var(--gold) 0%,
          #ffc92b 100%
        ); /* Warna gradasi tombol OTP */
        color: var(--brown); /* Warna teks tombol cokelat */
        font-weight: 700; /* Teks ditebalkan */
        font-size: 0.82rem; /* Ukuran teks sedikit lebih kecil */
        padding: 0 16px; /* Padding horizontal tombol */
        white-space: nowrap; /* Supaya teks tidak turun baris */
        cursor: pointer; /* Pointer saat hover */
        transition: transform 0.12s ease; /* Animasi kecil di hover */
        flex: 0 0 auto; /* Tombol tidak ikut melar */
      }
      .btn-verify:hover:not(:disabled) {
        transform: translateY(-1px); /* Tombol naik sedikit saat hover */
      }

      .pw-wrap {
        position: relative; /* Wrapper posisi relatif untuk tombol eye */
      }
      .pw-input {
        height: 40px; /* Tinggi input password */
        border-radius: 10px; /* Sudut membulat */
        padding-right: 42px; /* Tambah ruang di kanan untuk icon eye */
      }
      .pw-toggle {
        position: absolute; /* Posisi absolut di dalam pw-wrap */
        right: 10px; /* 10px dari tepi kanan input */
        top: 50%; /* Posisi vertikal di tengah */
        transform: translateY(-50%); /* Koreksi supaya benar-benar di tengah */
        background: transparent; /* Background tombol transparan */
        border: none; /* Tanpa border */
        width: 24px; /* Area klik lebar 24px */
        height: 24px; /* Area klik tinggi 24px */
        display: flex; /* Flex untuk center icon */
        align-items: center; /* Vertikal tengah icon */
        justify-content: center; /* Horizontal tengah icon */
        color: var(--brown); /* Warna icon cokelat */
        cursor: pointer; /* Pointer saat hover */
        padding: 0; /* Tanpa padding ekstra */
      }
      .pw-toggle i {
        font-size: 1rem; /* Ukuran icon mata */
      }

      .back-link {
        margin-top: 10px; /* Jarak dari form ke link kembali */
        font-size: 0.88rem; /* Ukuran teks kecil */
        color: var(--ink); /* Warna teks utama */
        text-align: center; /* Rata tengah */
      }
      .back-link a {
        color: #1a73e8; /* Warna link biru */
        text-decoration: none; /* Hilangkan garis bawah default */
        font-weight: 500; /* Teks link sedikit tebal */
      }
      .back-link a:hover {
        text-decoration: underline; /* Saat hover link diberi garis bawah */
      }

      /* === INLINE ALERT di bawah OTP (font diperkecil) === */
      .inline-alert {
        display: none; /* Tidak tampil secara default */
        margin-top: 8px; /* Jarak atas dari baris OTP */
        font-size: 0.82rem; /* diperkecil */ /* Ukuran teks alert kecil */
        line-height: 1.35; /* Tinggi baris cukup rapat */
        color: #000; /* hitam */ /* Warna teks alert hitam */
      }
      .inline-alert.is-visible {
        display: block; /* Saat punya class ini, alert ditampilkan */
      }

      /* Responsive tweaks */
      @media (max-width: 768px) {
        /* Aturan khusus untuk layar kecil */
        .form-stack {
          padding: 12px 14px; /* Padding form lebih kecil di mobile */
        }
        .header-brand .brand {
          font-size: 1.5rem; /* Ukuran judul brand disesuaikan di mobile */
        }
      }
    </style>
    <!-- Akhir style -->
  </head>
  <body>
    <!-- Awal body/konten utama -->
    <div class="reg-wrap">
      <!-- Wrapper untuk center card di tengah layar -->
      <div class="reg-card">
        <!-- Container utama form reset password -->
        <header class="header-brand">
          <!-- Bagian header judul & deskripsi -->
          <div class="muted">Reset kata sandi akun kamu</div>
          <!-- Subtitle yang menjelaskan halaman -->
        </header>

        <section class="form-stack">
          <!-- Seksi yang berisi seluruh form reset -->
          <!-- ALERT lama dibiarkan saja (tidak dipakai lagi) -->
          <div id="alertBox" class="d-none" role="alert"></div>
          <!-- Placeholder alert lama, sekarang disembunyikan -->

          <div class="form-group">
            <!-- Grup field email -->
            <label for="email" class="form-label">Email terdaftar</label>
            <!-- Label untuk input email -->
            <input type="email" id="email" class="form-control" readonly />
            <!-- Input email readonly, diisi dari URL -->
          </div>

          <div class="form-group">
            <!-- Grup field OTP -->
            <label for="otp" class="form-label">Kode OTP</label>
            <!-- Label untuk input OTP -->
            <div class="otp-row">
              <!-- Baris gabungan input OTP dan tombol verifikasi -->
              <input
                type="text"
                id="otp"
                class="form-control"
                placeholder="6 digit kode OTP"
                maxlength="6"
                autocomplete="one-time-code"
              />
              <!-- Input OTP 6 digit, dengan autocomplete khusus OTP -->
              <button type="button" id="btnVerifyOtp" class="btn-verify">
                Verifikasi
              </button>
              <!-- Tombol untuk memicu proses verifikasi OTP -->
            </div>

            <!-- Inline alert yang sekarang berada DI BAWAH form OTP -->
            <div id="inlineAlert" class="inline-alert" aria-live="polite"></div>
            <!-- Area pesan kecil terkait OTP (berubah dinamis) -->
          </div>

          <div class="form-group">
            <!-- Grup field password baru -->
            <label for="password" class="form-label">Password baru</label>
            <!-- Label password baru -->
            <div class="pw-wrap">
              <!-- Wrapper password + tombol eye -->
              <input
                type="password"
                id="password"
                class="form-control pw-input"
                placeholder="Minimal 6 karakter (huruf&angka)"
                disabled
              />
              <!-- Input password baru (disabled sampai OTP valid) -->
              <button
                type="button"
                class="pw-toggle"
                id="togglePassword"
                aria-label="Tampilkan/sembunyikan password"
              >
                <i class="bi bi-eye"></i>
              </button>
              <!-- Tombol untuk show/hide password baru -->
            </div>
          </div>

          <div class="form-group">
            <!-- Grup field konfirmasi password -->
            <label for="passwordConfirm" class="form-label">
              Konfirmasi password baru
            </label>
            <!-- Label konfirmasi password baru -->
            <div class="pw-wrap">
              <!-- Wrapper konfirmasi password + tombol eye -->
              <input
                type="password"
                id="passwordConfirm"
                class="form-control pw-input"
                placeholder="Ulangi password baru"
                disabled
              />
              <!-- Input konfirmasi password (juga disabled sampai OTP valid) -->
              <button
                type="button"
                class="pw-toggle"
                id="togglePasswordConfirm"
                aria-label="Tampilkan/sembunyikan konfirmasi password"
              >
                <i class="bi bi-eye"></i>
              </button>
              <!-- Tombol untuk show/hide konfirmasi password -->
            </div>
          </div>

          <button type="button" id="btnSavePassword" class="btn-brand" disabled>
            Simpan password baru
          </button>
          <!-- Tombol simpan password baru (aktif setelah OTP valid dan form oke) -->
        </section>

        <div class="back-link">
          <!-- Bagian link kembali ke login -->
          <small>Kembali ke halaman <a href="login.html">login</a></small>
          <!-- Link untuk kembali ke halaman login -->
        </div>
      </div>
    </div>

    <!-- ===== POPUP CAFFORA (GLOBAL) ===== -->
    <div id="popupOverlay" class="popup-overlay d-none" style="display: none">
      <div id="popupCard" class="popup-card" style="display: none">
        <div class="popup-title">Caffora</div>
        <!-- Judul di dalam popup kustom -->
        <div id="popupMessage" class="popup-message"></div>
        <!-- Area pesan popup dinamis -->
        <div class="popup-btn-row">
          <button type="button" id="popupOkBtn" class="popup-btn">Oke</button>
          <!-- Tombol OK untuk menutup popup -->
        </div>
      </div>
    </div>

    <script>
      <!-- Mulai script untuk logika reset password -->
      const emailInput = document.getElementById("email"); // Ambil elemen input email
      const otpInput = document.getElementById("otp"); // Ambil input OTP
      const btnVerifyOtp = document.getElementById("btnVerifyOtp"); // Tombol verifikasi OTP
      const passwordInput = document.getElementById("password"); // Input password baru
      const passwordConfirmInput = document.getElementById("passwordConfirm"); // Input konfirmasi password baru
      const btnSavePassword = document.getElementById("btnSavePassword"); // Tombol simpan password baru
      const togglePasswordBtn = document.getElementById("togglePassword"); // Tombol eye untuk password
      const togglePasswordConfirmBtn = document.getElementById(
        "togglePasswordConfirm"
      ); // Tombol eye untuk konfirmasi password

      // elemen popup (disembunyikan styling popup agar tidak tampil jika tidak digunakan)
      const popupOverlay = document.getElementById("popupOverlay"); // Overlay gelap di belakang popup
      const popupCard = document.getElementById("popupCard"); // Kartu popup utama
      const popupMessageEl = document.getElementById("popupMessage"); // Tempat menampilkan teks pesan
      const popupOkBtn = document.getElementById("popupOkBtn"); // Tombol "Oke" untuk menutup popup

      // elemen inline alert (di bawah OTP)
      const inlineAlert = document.getElementById("inlineAlert"); // Elemen inline alert kecil di bawah field OTP

      let popupCallback = null; // Menyimpan callback yang dijalankan setelah popup ditutup
      let currentEmail = ""; // Menyimpan email dari URL yang sedang di-reset
      let otpVerified = false; // Flag apakah OTP sudah diverifikasi dengan benar

      function showPopup(message, type = "error", callback) {
        // Tampilkan popup dengan pesan & tipe (error/success)
        // fallback: jika popup elemen tidak diaktifkan, gunakan alert browser
        if (!popupOverlay || !popupCard) {
          // Jika elemen popup tidak ada di DOM
          alert(message); // Pakai alert bawaan browser
          if (typeof callback === "function") callback(); // Jika ada callback, jalankan langsung
          return; // Hentikan fungsi
        }
        popupMessageEl.textContent = message || ""; // Isi pesan popup (fallback string kosong)
        popupCard.classList.remove("error", "success"); // Reset kelas status sebelumnya
        popupCard.classList.add(type === "success" ? "success" : "error"); // Tambahkan kelas sesuai tipe
        popupCallback = typeof callback === "function" ? callback : null; // Simpan callback jika valid
        popupOverlay.classList.remove("d-none"); // Tampilkan overlay (hilangkan d-none)
        void popupOverlay.offsetWidth; // Force reflow supaya transition bisa jalan
        popupOverlay.classList.add("is-visible"); // Tambahkan kelas visible untuk animasi
        popupOkBtn.focus(); // Fokuskan tombol OK untuk UX/aksesibilitas
      }

      function hidePopup() {
        // Sembunyikan popup kustom
        if (!popupOverlay) return; // Kalau overlay tidak ada, langsung keluar
        popupOverlay.classList.remove("is-visible"); // Hilangkan kelas visible (mulai animasi keluar)
        setTimeout(() => {
          popupOverlay.classList.add("d-none"); // Setelah animasi, sembunyikan overlay total
        }, 300); // Timeout 300ms (selaras dengan durasi transisi CSS)
      }

      if (popupOkBtn) {
        // Jika tombol OK tersedia
        popupOkBtn.addEventListener("click", () => {
          // Tambah event klik
          hidePopup(); // Tutup popup
          if (popupCallback) {
            // Jika ada callback yang disimpan
            const cb = popupCallback; // Simpan ke variabel lokal
            popupCallback = null; // Reset callback global
            cb(); // Jalankan callback (misal redirect)
          }
        });
      }

      if (popupOverlay) {
        // Jika overlay ada di DOM
        popupOverlay.addEventListener("click", (e) => {
          // Klik di overlay (bagian gelap)
          if (e.target === popupOverlay) {
            // Pastikan yang diklik area luar card
            hidePopup(); // Tutup popup
            popupCallback = null; // Reset callback agar tidak dijalankan
          }
        });
      }

      function showAlert(message, type = "error", callback) {
        // Wrapper untuk showPopup sebagai alert global
        // fallback pada popup/alert
        showPopup(message, type, callback); // Delegasikan ke showPopup
      }

      function hideAlert() {
        // Wrapper untuk menyembunyikan alert/popup
        hidePopup(); // Delegasikan ke hidePopup
      }

      // === INLINE ALERT ===
      function showInlineAlert(message) {
        // Tampilkan pesan kecil di bawah OTP
        if (!inlineAlert) return; // Jika elemen tidak ada, keluar
        inlineAlert.textContent = message || ""; // Set teks pesan
        inlineAlert.classList.add("is-visible"); // Tambahkan kelas supaya tampil
      }

      function hideInlineAlert() {
        // Sembunyikan inline alert
        if (!inlineAlert) return; // Jika elemen tidak ada, keluar
        inlineAlert.textContent = ""; // Hapus teks pesan
        inlineAlert.classList.remove("is-visible"); // Hilangkan kelas visible
      }

      // Ambil email dari URL (?email=...)
      (function initEmail() {
        // IIFE untuk inisialisasi email dari query string
        const params = new URLSearchParams(window.location.search); // Ambil semua parameter dari URL
        const emailParam = params.get("email"); // Ambil nilai untuk key "email"
        if (emailParam) {
          // Jika ada parameter email
          try {
            currentEmail = decodeURIComponent(emailParam); // Decode URL-encoded email
          } catch (e) {
            currentEmail = emailParam; // Jika gagal decode, pakai nilai mentah
          }
          emailInput.value = currentEmail; // Tampilkan email ke input readonly
        }
      })();

      function setPasswordFieldsEnabled(enabled) {
        // Enable/disable field password dan tombol simpan
        passwordInput.disabled = !enabled; // Toggle disabled pada input password
        passwordConfirmInput.disabled = !enabled; // Toggle disabled pada konfirmasi password
        btnSavePassword.disabled = !enabled; // Toggle disabled pada tombol simpan
      }

      function setupToggle(button, input) {
        // Setup tombol show/hide password untuk 1 input
        if (!button || !input) return; // Jika salah satu tidak ada, keluar
        button.addEventListener("click", () => {
          // Event klik pada icon mata
          const icon = button.querySelector("i"); // Cari elemen icon <i> di dalam tombol
          const isHidden = input.type === "password"; // Cek apakah input masih type password
          input.type = isHidden ? "text" : "password"; // Toggle type antara password/text
          if (icon) {
            // Jika icon ada
            icon.classList.toggle("bi-eye", !isHidden); // Jika setelah toggle jadi hidden: pakai bi-eye
            icon.classList.toggle("bi-eye-slash", isHidden); // Jika setelah toggle jadi terlihat: pakai bi-eye-slash
          }
        });
      }
      setupToggle(togglePasswordBtn, passwordInput); // Pasang toggle untuk input password baru
      setupToggle(togglePasswordConfirmBtn, passwordConfirmInput); // Pasang toggle untuk input konfirmasi password

      // VERIFIKASI OTP
      btnVerifyOtp.addEventListener("click", async () => {
        // Saat tombol verifikasi OTP diklik
        hideInlineAlert(); // Sembunyikan pesan kecil sebelumnya
        hideAlert(); // Tutup popup kalau sedang terbuka

        const otp = otpInput.value.trim(); // Ambil OTP dan trim spasi
        if (!currentEmail) {
          // Jika email kosong/tidak valid di URL
          showInlineAlert(
            "Email tidak valid di URL. Silakan ulangi langkah lupa password."
          ); // Tampilkan pesan error email
          return; // Batalkan proses
        }
        if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
          // Validasi OTP: harus 6 digit angka
          showInlineAlert("Kode OTP wajib diisi 6 digit angka."); // Pesan validasi OTP
          return; // Batalkan proses
        }

        btnVerifyOtp.disabled = true; // Disable tombol selama proses verifikasi
        btnVerifyOtp.textContent = "Memeriksa..."; // Ubah teks tombol menjadi status loading

        try {
          const res = await fetch("backend/auth_reset.php", {
            // Kirim request ke backend untuk verifikasi OTP
            method: "POST", // Metode POST
            headers: {
              "Content-Type": "application/json", // Body akan dikirim dalam bentuk JSON
              Accept: "application/json", // Harapkan response JSON
            },
            body: JSON.stringify({
              action: "verify_otp", // Aksi yang diminta: verifikasi OTP
              email: currentEmail, // Email target
              otp: otp, // Kode OTP dari input
            }),
          });

          const raw = await res.text(); // Ambil response mentah sebagai teks
          let data;
          try {
            data = JSON.parse(raw); // Coba parse JSON
          } catch (e) {
            console.error("Response bukan JSON:", raw); // Log jika format tidak JSON
            showAlert("Terjadi kesalahan pada server (response tidak valid)."); // Tampilkan popup error umum
            return; // Hentikan handler
          }

          if (data.status === "success") {
            // Jika verifikasi OTP sukses
            otpVerified = true; // Set flag OTP sudah terverifikasi
            setPasswordFieldsEnabled(true); // Aktifkan field password & tombol simpan
            showInlineAlert(
              data.message || "Kode OTP valid. Silakan buat password baru."
            ); // Tampilkan pesan sukses di bawah OTP
          } else {
            otpVerified = false; // OTP tidak valid
            setPasswordFieldsEnabled(false); // Pastikan field password tetap nonaktif
            showInlineAlert(
              data.message || "Kode OTP salah atau sudah kedaluwarsa."
            ); // Tampilkan pesan gagal OTP
          }
        } catch (err) {
          console.error(err); // Log error jaringan/JS
          showAlert("Terjadi kesalahan koneksi ke server."); // Tampilkan popup error koneksi
        } finally {
          btnVerifyOtp.disabled = false; // Re-enable tombol verifikasi
          btnVerifyOtp.textContent = "Verifikasi"; // Kembalikan teks tombol
        }
      });

      // SIMPAN PASSWORD BARU
      btnSavePassword.addEventListener("click", async () => {
        // Handler saat klik tombol simpan password baru
        hideInlineAlert(); // Bersihkan pesan kecil
        hideAlert(); // Tutup popup jika ada

        const otp = otpInput.value.trim(); // Ambil ulang OTP dari input
        const password = passwordInput.value; // Ambil password baru
        const passwordConfirm = passwordConfirmInput.value; // Ambil konfirmasi password baru

        if (!currentEmail) {
          // Cek lagi kalau email hilang
          showAlert(
            "Email tidak valid di URL. Silakan ulangi langkah lupa password."
          ); // Pesan error email invalid
          return; // Stop proses
        }
        if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
          // OTP masih harus valid
          showAlert("Kode OTP wajib diisi 6 digit angka."); // Pesan error OTP
          return; // Stop proses
        }
        if (!otpVerified) {
          // Jika OTP belum diverifikasi lewat tombol di atas
          showAlert(
            "Silakan verifikasi kode OTP terlebih dahulu sebelum mengganti password."
          ); // Instruksi verifikasi dulu
          return; // Stop proses
        }

        if (!password) {
          // Password wajib diisi
          showAlert("Password wajib diisi."); // Pesan error wajib diisi
          return; // Stop proses
        }
        if (password.length < 6 || password.length > 50) {
          // Cek panjang minimal & maksimal
          showAlert("Password harus minimal 6 karakter."); // Pesan validasi panjang
          return; // Stop proses
        }
        if (!/[A-Za-z]/.test(password) || !/[0-9]/.test(password)) {
          // Cek kombinasi huruf & angka
          showAlert("Password harus kombinasi huruf dan angka."); // Pesan rule password
          return; // Stop proses
        }
        if (password !== passwordConfirm) {
          // Cek kesesuaian konfirmasi password
          showAlert("Konfirmasi password tidak cocok."); // Pesan mismatch
          return; // Stop proses
        }

        btnSavePassword.disabled = true; // Disable tombol simpan saat request berjalan
        btnSavePassword.textContent = "Menyimpan..."; // Ubah label tombol ke status saving

        try {
          const res = await fetch("backend/auth_reset.php", {
            // Kirim request ke backend untuk reset password
            method: "POST", // Metode POST
            headers: {
              "Content-Type": "application/json", // Body JSON
              Accept: "application/json", // Expect response JSON
            },
            body: JSON.stringify({
              action: "reset_password", // Aksi reset_password
              email: currentEmail, // Email target
              otp: otp, // OTP yang digunakan
              password: password, // Password baru
              password_confirm: passwordConfirm, // Konfirmasi password baru
            }),
          });

          const raw = await res.text(); // Ambil response mentah
          let data;
          try {
            data = JSON.parse(raw); // Coba parse JSON
          } catch (e) {
            console.error("Response bukan JSON:", raw); // Log jika parsing gagal
            showAlert("Terjadi kesalahan pada server (response tidak valid)."); // Popup error format response
            return; // Stop handler
          }

          if (data.status === "success") {
            // Jika backend lapor sukses
            setPasswordFieldsEnabled(false); // Matikan lagi field password
            showAlert(
              data.message ||
                "Password berhasil diubah. Kamu akan dialihkan ke halaman login.",
              "success",
              () => {
                window.location.href = "login.html"; // Setelah user klik OK, redirect ke login
              }
            );
          } else {
            showAlert(data.message || "Gagal menyimpan password baru."); // Tampilkan pesan error dari server atau fallback
          }
        } catch (err) {
          console.error(err); // Log error jaringan/JS
          showAlert("Terjadi kesalahan koneksi ke server."); // Popup error koneksi
        } finally {
          btnSavePassword.disabled = false; // Re-enable tombol simpan agar bisa dicoba lagi
          btnSavePassword.textContent = "Simpan password baru"; // Kembalikan label tombol ke semula
        }
      });
    </script>
    <!-- Akhir script -->
  </body>
</html>
<!-- Akhir dokumen HTML -->
